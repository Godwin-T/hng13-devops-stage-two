version: "3.9"

services:
  app_blue:
    image: "${BLUE_IMAGE}"
    restart: unless-stopped
    environment:
      RELEASE_ID: "${RELEASE_ID_BLUE}"
      PORT: "3000"
      APP_POOL: "blue"
    expose:
      - "3000"
    ports:
      - target: "3000"
        published: 8081
        protocol: tcp
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"const http=require('http');http.get('http://127.0.0.1:3000/healthz',res=>{process.exit(res.statusCode===200?0:1);}).on('error',()=>process.exit(1));\"",
        ]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 20s

  app_green:
    image: "${GREEN_IMAGE}"
    restart: unless-stopped
    environment:
      RELEASE_ID: "${RELEASE_ID_GREEN}"
      PORT: "3000"
      APP_POOL: "green"
    expose:
      - "3000"
    ports:
      - target: "3000"
        published: 8082
        protocol: tcp
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"const http=require('http');http.get('http://127.0.0.1:3000/healthz',res=>{process.exit(res.statusCode===200?0:1);}).on('error',()=>process.exit(1));\"",
        ]
      interval: 20s
      timeout: 5s
      retries: 3
      start_period: 20s

  nginx:
    image: nginx:1.25-alpine
    restart: unless-stopped
    depends_on:
      app_blue:
        condition: service_healthy
      app_green:
        condition: service_healthy
    environment:
      ACTIVE_POOL: "${ACTIVE_POOL}"
      RELEASE_ID_BLUE: "${RELEASE_ID_BLUE}"
      RELEASE_ID_GREEN: "${RELEASE_ID_GREEN}"
      PORT: "${PORT:-3000}"
    ports:
      - "8080:8080"
    volumes:
      - ./nginx/nginx.conf.template:/etc/nginx/templates/default.conf.template:ro
      - ./nginx/entrypoint.sh:/usr/local/bin/nginx-entrypoint.sh:ro
      - nginx_logs:/var/log/nginx
    entrypoint: ["/usr/local/bin/nginx-entrypoint.sh"]

  alert_watcher:
    build:
      context: ./alert-watcher
    restart: unless-stopped
    depends_on:
      - nginx
    environment:
      SLACK_WEBHOOK_URL: "${SLACK_WEBHOOK_URL}"
      ALERT_ERROR_WINDOW: "${ALERT_ERROR_WINDOW:-200}"
      ALERT_ERROR_THRESHOLD: "${ALERT_ERROR_THRESHOLD:-0.02}"
      ALERT_COOLDOWN_SECONDS: "${ALERT_COOLDOWN_SECONDS:-300}"
      MAINTENANCE_FLAG_FILE: "${MAINTENANCE_FLAG_FILE:-/var/run/maintenance.on}"
      PRIMARY_POOL: "${ACTIVE_POOL}"
    volumes:
      - nginx_logs:/var/log/nginx:ro

volumes:
  nginx_logs:
